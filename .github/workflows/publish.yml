name: Build Platform Wheels

on:
  push:
    branches: [test_github_actions]
  workflow_dispatch:

jobs:
  build_and_publish:
    name: Build All Wheels on Linux
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://test.pypi.org/p/pyweworkfinance
    permissions:
      id-token: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        run: uv python install

      - name: Build All Platforms
        shell: bash
        run: |
          LIBS_BASE="src/pyweworkfinance/libs"
          # 备份原始 libs 目录，因为我们要进行破坏性修改（删除无关文件）
          cp -r $LIBS_BASE $LIBS_BASE/../libs_backup

          # 定义需要构建的平台列表
          # 格式: "目标名称|平台标签"
          PLATFORMS=("windows|win_amd64" "linux_x86|manylinux2014_x86_64" "linux_arm|manylinux2014_aarch64")

          for entry in "${PLATFORMS[@]}"; do
            IFS="|" read -r TARGET PLAT_NAME <<< "$entry"
            echo "------------------------------------------"
            echo "Processing target: $TARGET -> $PLAT_NAME"
            
            # 1. 还原 libs 目录
            rm -rf $LIBS_BASE
            cp -r $LIBS_BASE/../libs_backup $LIBS_BASE

            # 2. 根据目标清理文件
            if [ "$TARGET" == "windows" ]; then
              rm -rf $LIBS_BASE/linux
            elif [ "$TARGET" == "linux_x86" ]; then
              rm -rf $LIBS_BASE/windows
              rm -f $LIBS_BASE/linux/libWeWorkFinanceSdk_C_arm.so
            elif [ "$TARGET" == "linux_arm" ]; then
              rm -rf $LIBS_BASE/windows
              rm -f $LIBS_BASE/linux/libWeWorkFinanceSdk_C_x86.so
            fi

            # 3. 构建该平台的 Wheel
            # 注意：使用 --no-sdist 避免重复生成源码包
            uv build --wheel --no-sdist --config-setting="--build-option=--plat-name=$PLAT_NAME"
          done

          # 4. 最后单独生成一个源码包 (sdist)
          uv build --sdist

      - name: Show Built Files
        run: ls -lh dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
