name: Build Platform Wheels

on:
  push:
    branches: [test_github_actions]
  workflow_dispatch:

jobs:
  build_and_publish:
    name: Build All Wheels on Linux
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://test.pypi.org/p/pyweworkfinance
    permissions:
      id-token: write
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Python
        run: uv python install

      - name: Build All Platforms
        shell: bash
        run: |
          # --- 1. 初始化路径变量 ---
          LIBS_BASE="src/pyweworkfinance/libs"
          BACKUP_DIR="libs_source_backup"
          TEMP_DIST="dist_accumulator"

          # 创建临时目录
          mkdir -p $TEMP_DIST

          # --- 2. 备份原始 libs 目录 ---
          # 直接备份到根目录下的独立文件夹，不再使用 ../ 这种相对路径
          cp -r $LIBS_BASE $BACKUP_DIR

          # --- 3. 循环构建各个平台 ---
          PLATFORMS=("windows|win_amd64" "linux_x86|manylinux2014_x86_64" "linux_arm|manylinux2014_aarch64")

          for entry in "${PLATFORMS[@]}"; do
            IFS="|" read -r TARGET PLAT_NAME <<< "$entry"
            echo "------------------------------------------"
            echo "Processing target: $TARGET -> $PLAT_NAME"
            
            # 还原 libs 目录：先彻底删除旧的，再从根目录备份处拷贝新的
            rm -rf $LIBS_BASE
            cp -r $BACKUP_DIR $LIBS_BASE

            # 根据目标清理无关的动态库文件
            if [ "$TARGET" == "windows" ]; then
              rm -rf $LIBS_BASE/linux
            elif [ "$TARGET" == "linux_x86" ]; then
              rm -rf $LIBS_BASE/windows
              rm -f $LIBS_BASE/linux/libWeWorkFinanceSdk_C_arm.so
            elif [ "$TARGET" == "linux_arm" ]; then
              rm -rf $LIBS_BASE/windows
              rm -f $LIBS_BASE/linux/libWeWorkFinanceSdk_C_x86.so
            fi

            # 执行构建
            # 使用 --out-dir 确保文件存入临时目录
            # uv build 默认会清空输出目录，所以我们每个平台单独构建后，文件会自动堆积在 TEMP_DIST
            uv build --wheel --no-sdist \
              --config-setting="--build-option=--plat-name=$PLAT_NAME" \
              --out-dir $TEMP_DIST
          done

          # --- 4. 单独生成源码包 ---
          uv build --sdist --out-dir $TEMP_DIST

          # --- 5. 整理最终产物 ---
          # 移除自动生成的 dist（如果存在），将积累的所有包移入真正的 dist 目录
          rm -rf dist
          mv $TEMP_DIST dist

          # 清理备份文件夹
          rm -rf $BACKUP_DIR

      - name: Show Built Files
        run: ls -lh dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
